// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–ª–æ–¥–≤–∏–∂–µ–Ω–∏—è

// –ò–º–ø–æ—Ä—Ç
const FS = require('fs'); // File System
const path = require('./path'); // –ü—É—Ç–∏
const str = require('./str'); // –°—Ç—Ä–æ–∫–∏
const {google} = require('googleapis');
const googleCreditionals = require('../json/GoogleCreditionals.json');
const config = require('../json/config.json');


// –≠–º–æ–¥–∂–∏:)
var emojis = [
	'üòÑ','üòÉ','üòÄ','üòä','‚ò∫','üòâ','üòç','üòò','üòö','üòó','üòô','üòú','üòù','üòõ','üò≥','üòÅ','üòî','üòå','üòí','üòû','üò£','üò¢','üòÇ','üò≠','üò™','üò•','üò∞','üòÖ','üòì','üò©','üò´','üò®','üò±','üò†','üò°','üò§','üòñ','üòÜ','üòã','üò∑','üòé','üò¥','üòµ','üò≤','üòü','üò¶','üòß','üòà','üëø','üòÆ','üò¨','üòê','üòï','üòØ','üò∂','üòá','üòè','üòë','üë≤','üë≥','üëÆ','üë∑','üíÇ','üë∂','üë¶','üëß','üë®','üë©','üë¥','üëµ','üë±','üëº','üë∏','üò∫','üò∏','üòª','üòΩ','üòº','üôÄ','üòø','üòπ','üòæ','üëπ','üë∫','üôà','üôâ','üôä','üíÄ','üëΩ','üí©','üî•','‚ú®','üåü','üí´','üí•','üí¢','üí¶','üíß','üí§','üí®','üëÇ','üëÄ','üëÉ','üëÖ','üëÑ','üëç','üëé','üëå','üëä','‚úä','‚úå','üëã','‚úã','üëê','üëÜ','üëá','üëâ','üëà','üôå','üôè','‚òù','üëè','üí™','üö∂','üèÉ','üíÉ','üë´','üë™','üë¨','üë≠','üíè','üíë','üëØ','üôÜ','üôÖ','üíÅ','üôã','üíÜ','üíá','üíÖ','üë∞','üôé','üôç','üôá','üé©','üëë','üëí','üëü','üëû','üë°','üë†','üë¢','üëï','üëî','üëö','üëó','üéΩ','üëñ','üëò','üëô','üíº','üëú','üëù','üëõ','üëì','üéÄ','üåÇ','üíÑ','üíõ','üíô','üíú','üíö','‚ù§','üíî','üíó','üíì','üíï','üíñ','üíû','üíò','üíå','üíã','üíç','üíé','üë§','üë•','üí¨','üë£','üí≠','üê∂','üê∫','üê±','üê≠','üêπ','üê∞','üê∏','üêØ','üê®','üêª','üê∑','üêΩ','üêÆ','üêó','üêµ','üêí','üê¥','üêë','üêò','üêº','üêß','üê¶','üê§','üê•','üê£','üêî','üêç','üê¢','üêõ','üêù','üêú','üêû','üêå','üêô','üêö','üê†','üêü','üê¨','üê≥','üêã','üêÑ','üêè','üêÄ','üêÉ','üêÖ','üêá','üêâ','üêé','üêê','üêì','üêï','üêñ','üêÅ','üêÇ','üê≤','üê°','üêä','üê´','üê™','üêÜ','üêà','üê©','üêæ','üíê','üå∏','üå∑','üçÄ','üåπ','üåª','üå∫','üçÅ','üçÉ','üçÇ','üåø','üåæ','üçÑ','üåµ','üå¥','üå≤','üå≥','üå∞','üå±','üåº','üåê','üåû','üåù','üåö','üåë','üåí','üåì','üåî','üåï','üåñ','üåó','üåò','üåú','üåõ','üåô','üåç','üåé','üåè','üåã','üåå','üå†','‚≠ê','‚òÄ','‚õÖ','‚òÅ','‚ö°','‚òî','‚ùÑ','‚õÑ','üåÄ','üåÅ','üåà','üåä','üéç','üíù','üéé','üéí','üéì','üéè','üéÜ','üéá','üéê','üéë','üéÉ','üëª','üéÖ','üéÑ','üéÅ','üéã','üéâ','üéä','üéà','üéå','üîÆ','üé•','üì∑','üìπ','üìº','üíø','üìÄ','üíΩ','üíæ','üíª','üì±','‚òé','üìû','üìü','üì†','üì°','üì∫','üìª','üîä','üîâ','üîà','üîá','üîî','üîï','üì¢','üì£','‚è≥','‚åõ','‚è∞','‚åö','üîì','üîí','üîè','üîê','üîë','üîé','üí°','üî¶','üîÜ','üîÖ','üîå','üîã','üîç','üõÅ','üõÄ','üöø','üöΩ','üîß','üî©','üî®','üö™','üö¨','üí£','üî´','üî™','üíä','üíâ','üí∞','üí¥','üíµ','üí∑','üí∂','üí≥','üí∏','üì≤','üìß','üì•','üì§','‚úâ','üì©','üì®','üìØ','üì´','üì™','üì¨','üì≠','üìÆ','üì¶','üìù','üìÑ','üìÉ','üìë','üìä','üìà','üìâ','üìú','üìã','üìÖ','üìÜ','üìá','üìÅ','üìÇ','‚úÇ','üìå','üìé','‚úí','‚úè','üìè','üìê','üìï','üìó','üìò','üìô','üìì','üìî','üìí','üìö','üìñ','üîñ','üìõ','üî¨','üî≠','üì∞','üé®','üé¨','üé§','üéß','üéº','üéµ','üé∂','üéπ','üéª','üé∫','üé∑','üé∏','üëæ','üéÆ','üÉè','üé¥','üÄÑ','üé≤','üéØ','üèà','üèÄ','‚öΩ','‚öæ','üéæ','üé±','üèâ','üé≥','‚õ≥','üöµ','üö¥','üèÅ','üèá','üèÜ','üéø','üèÇ','üèä','üèÑ','üé£','‚òï','üçµ','üç∂','üçº','üç∫','üçª','üç∏','üçπ','üç∑','üç¥','üçï','üçî','üçü','üçó','üçñ','üçù','üçõ','üç§','üç±','üç£','üç•','üçô','üçò','üçö','üçú','üç≤','üç¢','üç°','üç≥','üçû','üç©','üçÆ','üç¶','üç®','üçß','üéÇ','üç∞','üç™','üç´','üç¨','üç≠','üçØ','üçé','üçè','üçä','üçã','üçí','üçá','üçâ','üçì','üçë','üçà','üçå','üçê','üçç','üç†','üçÜ','üçÖ','üåΩ','üè†','üè°','üè´','üè¢','üè£','üè•','üè¶','üè™','üè©','üè®','üíí','‚õ™','üè¨','üè§','üåá','üåÜ','üèØ','üè∞','‚õ∫','üè≠','üóº','üóæ','üóª','üåÑ','üåÖ','üåÉ','üóΩ','üåâ','üé†','üé°','‚õ≤','üé¢','üö¢','‚õµ','üö§','üö£','‚öì','üöÄ','‚úà','üí∫','üöÅ','üöÇ','üöä','üöâ','üöû','üöÜ','üöÑ','üöÖ','üöà','üöá','üöù','üöã','üöÉ','üöé','üöå','üöç','üöô','üöò','üöó','üöï','üöñ','üöõ','üöö','üö®','üöì','üöî','üöí','üöë','üöê','üö≤','üö°','üöü','üö†','üöú','üíà','üöè','üé´','üö¶','üö•','‚ö†','üöß','üî∞','‚õΩ','üèÆ','üé∞','‚ô®','üóø','üé™','üé≠','üìç','üö©',
];

module.exports = {

    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    LoadEvents: function(Client) {
        
        const eventFiles = FS.readdirSync(path.EVENTS).filter(file => file.endsWith('.js'));

        eventFiles.forEach(file => {
            const eventHandler = require(`${path.EVENTS}/${file}`); // –§–∞–π–ª –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
            const eventName = file.split('.')[0]; // –ò–º—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
            Client.on(eventName, (...args) => eventHandler(Client, ...args)); // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏—è
        });
    },

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∫–æ–º–∞–Ω–¥
    FillCommands: function(commands) {

        const commandFiles = FS.readdirSync(path.COMMANDS).filter(file => file.endsWith('.js'));

        commandFiles.forEach(file => {
            const command = require(`${path.COMMANDS}/${file}`); // –§–∞–π–ª –∫–æ–º–∞–Ω–¥—ã
	            commands.set(command.name, command); // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é
        });
    },

    // –ü–æ–ª—É—á–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã –≥—É–≥–ª-–¥–∏—Å–∫–∞
    GetGoogleService: function() {

        const scopes = [
            'https://www.googleapis.com/auth/drive',
            'https://www.googleapis.com/auth/drive.file',
            'https://www.googleapis.com/auth/drive.appdata',
            'https://www.googleapis.com/auth/drive.scripts',
            'https://www.googleapis.com/auth/drive.metadata'
        ];

        const auth = new google.auth.JWT(
            googleCreditionals.client_email, null,
            googleCreditionals.private_key, scopes
        );

        return google.drive({ version: "v3", auth });
    },

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ –≥—É–≥–ª-–¥–∏—Å–∫–∞
    DownloadGoogleDriveFile: function(fileId, destination) {

        const drive = this.GetGoogleService();

        drive.files
            .get({fileId, alt: 'media'}, {responseType: 'stream'})
            .then(res => async function() {
                return await new Promise((resolve, reject) => {
                    let dest = FS.createWriteStream(destination);
                    res.data.pipe(dest);

                    res.data.on("error", (err) => {
                        reject(err);
                    });
                    dest.on("finish", function() {
                        resolve();
                    });
                });    
            });
    },

    // –û–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª –Ω–∞ –≥—É–≥–ª-–¥–∏—Å–∫–µ
    UpdateGoogleDriveFile: function(fileId, destination) {

        const drive = this.GetGoogleService();

        const media = {
            mimeType: 'application/json',
            body: FS.createReadStream(destination)
        };

        drive.files.update({
            fileId: fileId,
            media: media
        });
    },

    // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è –∫–æ–º–∞–Ω–¥—ã Poll
    GetPollArgs: function(message) {

        let args = message.content.match(/"(\\.|[^"\\])*"/g); // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–Ω–∏–µ - –±–µ—Ä–µ–º –≤—Å–µ –ø–æ–¥—Å—Ç—Ä–æ–∫–∏ –≤ –∫–∞–≤—ã—á–∫–∞—Ö

        // –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞–≤—ã—á–µ–∫ –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
        if (args && args.length) {
            args.forEach(function(part, index) {
                args[index] = args[index].replace(/"/g, '');
            });
        };

        return args;
    },

    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    CheckPollEmptyAnswers: function(answers) {

        let filteredAnswers = answers.filter(el => {
            return el != '';
        });
        
        return filteredAnswers;
    },

    // –û—Ç–≤–µ—Ç–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å –æ—Ç–≤–µ—Ç –≤–º–µ—Å—Ç–µ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
    MsgReplyAndDelete: function(message, reply, time = 6){
        
        message.reply(reply)
        .then(msg => {msg.delete({ timeout: time * 1000 }) }) // –£–¥–∞–ª–∏–º –æ—Ç–≤–µ—Ç
        .then(() => message.delete({ timeout: time * 1000 })) // –£–¥–∞–ª–∏–º –∫–æ–º–∞–Ω–¥—É
        .catch(console.error);
    },

    // –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    MsgDelete: function(message, time){
        
        message.delete({ timeout: time * 1000 }) // –£–¥–∞–ª–∏–º –∫–æ–º–∞–Ω–¥—É
        .catch(console.error);
    },

    // –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–Ω–¥–æ–º–Ω—ã–µ —ç–º–æ–¥–∂–∏
    GetRandomEmojis: function(count) {
        
        let result = [];
        let copyEmojis = emojis;

        for (let i = 0; i < count; i++) {
            emojiIndex = Math.floor(Math.random() * copyEmojis.length); // –ü–æ–ª—É—á–∏–º –∏–Ω–¥–µ–∫—Å
            result.push(copyEmojis[emojiIndex]); // –î–æ–±–∞–≤–∏–º –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            copyEmojis.splice(emojiIndex, 1); // –£–¥–∞–ª–∏–º, —á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–ª–æ—Å—å
        };
        
        return result;
    },

    // –ù–∞–π—Ç–∏ –≤–∏—Ä—Ç—É–∞–ª–∫—É –ø–æ –∞–π–¥–∏—à–Ω–∏–∫—É
    GetLinuxCar: function(id, pathFile) {
        
        // –ü—Ä–æ–≤–µ—Ä–∏–º –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        carID = Number(id);
        if (isNaN(carID)) {
            utils.MsgReplyAndDelete(message, str.COMMAND_BADFORMAT_ARGS);
            return null;
        };

        // –ü–æ–ª—É—á–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞
        let LinuxCars = JSON.parse(FS.readFileSync(pathFile));

        // –ù–∞–π–¥–µ–º –≤–∏—Ä—Ç—É–∞–ª–∫—É
        for (var key in LinuxCars) {
            if (LinuxCars.hasOwnProperty(key)) {
                let car = LinuxCars[key];
                if (car.ID == carID) {
                    return car;
                };
            };
        };

        return null;
    },

    // –ù–∞–π—Ç–∏ –∫–ª—é—á –≤–∏—Ä—Ç—É–∞–ª–∫–∏
    GetLinuxCarKey: function(car) {
        
        // –ü–æ–ª—É—á–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞
        let LinuxCars = JSON.parse(FS.readFileSync(path.LINUXCARS));
        
        // –ù–∞–π–¥–µ–º –∫–ª—é—á
        for (var key in LinuxCars) {
            tmpCar = LinuxCars[key];
            if (LinuxCars.hasOwnProperty(key) && JSON.stringify(car) === JSON.stringify(tmpCar)) {
                return key;
            };
        };

        return null;
    },

    // –ó–∞–Ω—è—Ç—å –≤–∏—Ä—Ç—É–∞–ª–∫—É
    TakeLinuxCar: async function(car, userId, userName) {
        
        // –ü–æ–ª—É—á–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞
        let LinuxCarsStatus = JSON.parse(FS.readFileSync(path.TMP_LINUXCARS_STATUS));
        
        // –ü–æ–ª—É—á–∏–º –∫–ª—é—á
        let carKey = this.GetLinuxCarKey(car);

        // –ò–∑–º–µ–Ω–∏–º –¥–∞–Ω–Ω—ã–µ
        LinuxCarsStatus[carKey].CurrentUser.ID = userId;
        LinuxCarsStatus[carKey].CurrentUser.Name = userName;

        // –°–æ—Ö—Ä–∞–Ω–∏–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        await FS.writeFileSync(path.TMP_LINUXCARS_STATUS, JSON.stringify(LinuxCarsStatus, null, 4));

        // –û–±–Ω–æ–≤–∏–º —Ñ–∞–π–ª –Ω–∞ –≥—É–≥–ª-–¥–∏—Å–∫–µ
        this.UpdateGoogleDriveFile(config.linStatusFileId, path.TMP_LINUXCARS_STATUS);
    },

    // –û—Å–≤–æ–±–æ–¥–∏—Ç—å –≤–∏—Ä—Ç—É–∞–ª–∫—É
    FreeLinuxCar: async function(car) {
        
        // –ü–æ–ª—É—á–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞
        let LinuxCarsStatus = JSON.parse(FS.readFileSync(path.TMP_LINUXCARS_STATUS));
        
        // –ü–æ–ª—É—á–∏–º –∫–ª—é—á
        let carKey = this.GetLinuxCarKey(car);

        // –ò–∑–º–µ–Ω–∏–º –¥–∞–Ω–Ω—ã–µ
        LinuxCarsStatus[carKey].CurrentUser.ID = "";
        LinuxCarsStatus[carKey].CurrentUser.Name = "";

        // –°–æ—Ö—Ä–∞–Ω–∏–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        await FS.writeFileSync(path.TMP_LINUXCARS_STATUS, JSON.stringify(LinuxCarsStatus, null, 4));

        // –û–±–Ω–æ–≤–∏–º —Ñ–∞–π–ª –Ω–∞ –≥—É–≥–ª-–¥–∏—Å–∫–µ
        this.UpdateGoogleDriveFile(config.linStatusFileId, path.TMP_LINUXCARS_STATUS);
    },
}